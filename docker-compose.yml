services:
  db:
    image: mariadb:11.8.3
    container_name: ecolitio_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: ecolitio_db
      MYSQL_USER: ecolitio_user
      MYSQL_PASSWORD: ecolitio_pass
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - ecolitio_network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    command: --innodb-buffer-pool-size=256M --innodb-log-file-size=64M --max-connections=100

  wordpress:
    image: wordpress:6.8.3
    container_name: ecolitio_wp
    restart: unless-stopped
    ports:
      - "8080:80"
    environment:
      # Conexión a staging database
      WORDPRESS_DB_HOST: ${STAGING_DB_HOST}
      WORDPRESS_DB_NAME: ${STAGING_DB_NAME}
      WORDPRESS_DB_USER: ${STAGING_DB_USER}
      WORDPRESS_DB_PASSWORD: ${STAGING_DB_PASSWORD}

      # Configuración de desarrollo
      WORDPRESS_DEBUG: 1
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_DEBUG_LOG', true);
        define('WP_DEBUG_DISPLAY', true);
        define('SCRIPT_DEBUG', true);
        define('WP_ENVIRONMENT_TYPE', 'development');
        define('FS_METHOD', 'direct');
        define('MYSQL_CLIENT_FLAGS', MYSQLI_CLIENT_SSL_DONT_VERIFY_SERVER_CERT);
    volumes:
      - wp_data:/var/www/html
      # Mapeo del tema en desarrollo
      - ./themes/ecolitio-theme:/var/www/html/wp-content/themes/ecolitio-theme
      - ./themes/storefront:/var/www/html/wp-content/themes/storefront
      # Mapeo de plugins personalizados
      - ./plugins:/var/www/html/wp-content/plugins
      # Mapeo de uploads (opcional, para archivos locales)
      - ./uploads:/var/www/html/wp-content/uploads
      # Log files
      - ./logs/wordpress.log:/var/log/wordpress.log
      - ./logs/debug.log:/var/www/html/wp-content/debug.log
    networks:
      - ecolitio_network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  # WP-CLI para comandos de WordPress
  wp-cli:
    image: wordpress:cli-php8.2
    container_name: ecolitio_wp_cli
    environment:
      WORDPRESS_DB_HOST: ${STAGING_DB_HOST}
      WORDPRESS_DB_NAME: ${STAGING_DB_NAME}
      WORDPRESS_DB_USER: ${STAGING_DB_USER}
      WORDPRESS_DB_PASSWORD: ${STAGING_DB_PASSWORD}
    volumes:
      - wp_data:/var/www/html
      - ./themes/ecolitio-theme:/var/www/html/wp-content/themes/ecolitio-theme
      - ./plugins:/var/www/html/wp-content/plugins
    networks:
      - ecolitio_network
    profiles:
      - cli

networks:
  ecolitio_network:
    driver: bridge

volumes:
  wp_data:
  db_data: